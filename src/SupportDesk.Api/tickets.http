@baseUrl = https://localhost:7076
@ticketId = tickets/65-A
@idempotencyKey = 11111111-1111-1111-1111-111111111112

### ------------------------------------------------------------------
### 0) API health check
### ------------------------------------------------------------------
GET {{baseUrl}}/

### ------------------------------------------------------------------
### 1) Create ticket
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets
Idempotency-Key: {{idempotencyKey}}
Content-Type: application/json

{
  "customerId": "cust-123",
  "subject": "Cannot log in",
  "description": "User reports login fails with 500 error",
  "priority": "High",
  "tags": ["login", "auth"]
}

### ------------------------------------------------------------------
### 2) Get full ticket (write model)
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets?id={{ticketId}}

### ------------------------------------------------------------------
### 3) Inbox (read model projection)
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets/inbox

### ------------------------------------------------------------------
### 4) INVALID workflow transition (Open -> Closed)
###    Should fail + emit RejectedTransition
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets/status:close?id={{ticketId}}
Content-Type: application/json

{
  "reason": "Trying to skip steps"
}

### ------------------------------------------------------------------
### 5) Start work (Open -> Pending)
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets/status:startwork?id={{ticketId}}
Content-Type: application/json

{
  "reason": "Agent picked this up"
}

### ------------------------------------------------------------------
### 6) Resolve ticket (Pending -> Resolved)
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets/status:resolve?id={{ticketId}}
Content-Type: application/json

{
  "reason": "Issue fixed"
}

### ------------------------------------------------------------------
### 7) INVALID close (Resolved -> Closed) without comment
###    Guard should fail (needs at least 1 comment)
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets/status:close?id={{ticketId}}
Content-Type: application/json

{
  "reason": "Customer silent"
}

### ------------------------------------------------------------------
### 8) Add comment
### ------------------------------------------------------------------
#POST {{baseUrl}}/tickets/{{ticketId}}/comments
POST {{baseUrl}}/tickets/comments?id={{ticketId}}
Content-Type: application/json

{
  "author": "agent.jane",
  "message": "Customer confirmed the fix works"
}

### ------------------------------------------------------------------
### 9) Close ticket (Resolved -> Closed) – guard passes
### ------------------------------------------------------------------
POST {{baseUrl}}/tickets/status:close?id={{ticketId}}
Content-Type: application/json

{
  "reason": "Customer confirmed resolution"
}

### ------------------------------------------------------------------
### 10) Update non-workflow fields
### ------------------------------------------------------------------
PUT {{baseUrl}}/tickets?id={{ticketId}}
Content-Type: application/json

{
  "subject": "Login issue resolved",
  "description": "Final notes added after confirmation",
  "priority": "Normal",
  "tags": ["login", "resolved"]
}

### ------------------------------------------------------------------
### 11) Inbox filtered by status
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets/inbox?status=Closed

### ------------------------------------------------------------------
### 12) Inbox paging (limit = 1)
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets/inbox?limit=1

> {%
  if (response.body.nextCursor) {
    client.global.set("inboxCursor", response.body.nextCursor);
  }
%}

### ------------------------------------------------------------------
### 13) Inbox paging (next page)
### ------------------------------------------------------------------
@inboxCursorAgain = "MjAyNi0wMS0wOVQyMjowMjozMS43ODUwNDgyKzAwOjAwfHRpY2tldHMvNjUtQQ=="
GET {{baseUrl}}/tickets/inbox?limit=1&cursor={{inboxCursorAgain}}

### ------------------------------------------------------------------
### 14) Timeline (event stream)
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets/timeline?id={{ticketId}}

### ------------------------------------------------------------------
### 15) Timeline paging (limit = 3)
### ------------------------------------------------------------------
GET {{baseUrl}}/tickets/timeline?id={{ticketId}}&limit=3

> {%
  if (response.body.nextCursor) {
    client.global.set("timelineCursor", response.body.nextCursor);
  }
%}

### ------------------------------------------------------------------
### 16) Timeline paging (next page)
### ------------------------------------------------------------------
@timelineCursorAgain = "MjAyNjAxMDkyMjAwNTQ3MTM5NTUyfHRpY2tldC1hY3Rpdml0eS90aWNrZXRzLzY1LUEvMjAyNjAxMDkyMjAwNTQ3MTM5NTUyLWIwZmQyNzYxZjU1ZjQwMmVhMmQ3NDNjZDQ1OTEyNzk4"
GET {{baseUrl}}/tickets/timeline?id={{ticketId}}&limit=3&cursor={{timelineCursorAgain}}
